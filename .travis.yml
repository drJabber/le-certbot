services: docker
language: bash
install:
  - env | sort
  - git clone https://github.com/docker-library/official-images.git ~/official-images
  - docker run -it --rm --name nvchecker --mount type=bind,source=${PWD},target=/data/ -w /data -e NVCHECKER_GITHUB_TOKEN=${GH_TOKEN} snw35/nvchecker:latest nvchecker nvchecker.ini
  - docker run -it --rm --name dfupdate --mount type=bind,source=${PWD},target=/data/ -w /data snw35/dfupdate:latest
  - if [[ $(git status --porcelain | wc -l) -eq 0 ]] && [[ -z ${TRAVIS_TAG} ]]; then
      echo "No local changes detected and no tag set, nothing to build, exiting.";
      travis_terminate 0;
    else
      echo "Local changes or tagged commit detected, continuing...";
    fi

before_script:
  - CERTBOT_VERSION=`grep "ENV CERTBOT_VERSION" Dockerfile | cut -d " " -f 3`
  - BASE_VERSION=`grep "FROM" Dockerfile | cut -d " " -f 2 | cut -d ":" -f 2`
  - IMAGE="${TRAVIS_REPO_SLUG}:${CERTBOT_VERSION}"
  - PROPOSED_TAG=${CERTBOT_VERSION}-${BASE_VERSION}
  - git config --local user.name "${DOCKER_USERNAME}"
  - git config --local user.email "snw35@use.startmail.com"
  - git remote add upstream https://${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git > /dev/null 2>&1
  - if [ $(git ls-remote --tags upstream "${PROPOSED_TAG}" | wc -l) -eq 0 ]; then
      echo "Propsoed tag does not exist on remote, continuing.";
    else
      echo "Proposed tag already exists on remote, skipping container build.";
      travis_terminate 0;
    fi

script:
  - env | sort
  - travis_retry docker build -t "$IMAGE" .
  - ~/official-images/test/run.sh "$IMAGE" || travis_terminate 1;
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker push "$IMAGE"
  - docker tag "$IMAGE" "${TRAVIS_REPO_SLUG}:latest"
  - docker push "${TRAVIS_REPO_SLUG}:latest"

after_script:
  - docker images

before_deploy:
  - cp new_ver.txt old_ver.txt
  - git checkout master
  - git add -A
  - git commit --message "Software Updated"
  - git tag $PROPOSED_TAG
  - git push --quiet --set-upstream upstream
  - git push --tags --quiet --set-upstream upstream

deploy:
  provider: releases
  api_key: $GH_TOKEN
  skip_cleanup: true
  body: >
    base image version: $BASE_VERSION
    certbot version: $CERTBOT_VERSION
    image deployed: $IMAGE

branches:
  except:
    - /^untagged/

env:
  global:
  - secure: qVRnqynKZIU8g5xafXhjp1dU13f0fvN3F2MpYyZBZwyFRJTtiuAQ1qaAocR/kD2JBaPAGdUnZuoSbhYTDrN4u/CEoX3KRXVEQjtfmybAGNAXZJYm3xj2C2fkDns18CihCrXXnTw1r8WeMsAaG8PCJWhJGMUtJQDGtTm7hrmwb2gHZ0R6OGpMFBrf48e0q/sZkGsvEtgtEPauywPuesMPQQRfrcy8ataUGiOwMPGoXMhrwHTg9uQWZ/E5it7UBO//IzE/jlBEo3uYlr24kM2hO6tILAI2ykAXC3DFAbIMBgwE4TrQjMsDIueMDDU5SFeDfZMLm+VI9wMkN+77qFAqr7mNYD5oipZnsnjWMiu88uTqVqfRtfhZklkB9Da/3dO9JlNMXEi2kHz4JJ68mwUWTvXnnPeQkYIgXsdPZ4sfIlsgIxEpiWQ9PtuSnznixSwDJ/d+esm7AZoG23lamw5mP9J6OuKfBnQ1FPqywz2Rt5BzuEz4SOs2bKS+gkCeRwbHWknnkamCLaxhnZnf3LIkPD8+w3sOWe+4YKeI54CXumBB+afHagDTWlBIyBvUMzjEel/BGArBxkW2iKKX5etvE83+uG9zE8HpR9yQ4N4CT+W2nkQqC2NPaVr1haPtTbaSbfpCd/iCW9U0ht5MBEDkD4NN+xd8FZ8uC7njDQzemQo=
  - secure: VU8GhOpfulvhgSiOr8wlYDcxp3qxH6g5yahT6SiWDCQvGp/mFOvXLPdvEp7rZiASkNzUQwTVMkJLvCsuecCUhjQrPNb4W1W2U1DNQi9mmYJVcIC24DDXOscFZLJ2DeDO32lZZc6w+jFLbaDmT4WV1/F0SRX+9bC1LNYTxtU8t87UQI/jE5AUsDLeAp/Pn/v5HZTvWbK03J0xgH8D4dj92hnCn3tOkTXxm0D3iU1UOMrRi3GcfK3aZGy1MYFe9xTC19ck5UvL7ZnKHGzFkpOsgiVXN4k3dld7qGIKnwmk/9sBDI10+QgO1SwFkWdSFvYQnDdUJJEXxwqCVUPPg0eQ4yTiM0yLZHGTbXVc84fFZnN5qodc/nPVcYGtlw+I91alxfBR3mNFc4l5J9QwJl/CqruhREzaUmhcfL4dfCZuXFdn0fMVi18eMUFprEHBbC1rCHcEcDG9aqUBTt3SOC9LChKW54RcQiG+73wIVipppWKGKG/cAYFimyemV4fcV5cmadpnqqcxlIDWLipNSL5rfJ5jkDBOKxBUyBuLU+c+nEBsn77xrHuyrGU9soNBQ320veWaCifOKNuCPVKI25tUuRAnMRBh5h+i7MV0AlTa7CoWgSUiPB4nu0478zGSEX8TqRP9Eat2SmpF86wuFfj70zixEEwBppv7W0dHrUl1UFU=
  - secure: cxlY2Wfk4x+LKuglvVnHoimvccogBG9NzPCCCbG76RqsZZRRYyOamLLuY7SVZMqSQ4q8i8MTVDW/JEqRhfxDwMmw31WYbc0r2ITZV7Kl3kcrXCaBMjr3RAm8KP23eB4mXo0L8fBKWHqCyomDzn2/PPTfwxjl/vlMojnZ7qrn6A5HbrcjCpwdHPuOMS283KnOv1b4aKxDAuRJTmXzPHQQ+slKTT89zx1R1bmbAuQsZ9DFg7MQ1WUpGLGo174n2FJsp9TZD2v2N7OawA3JzwV82h7OhhGqvfWEWheESyoh76Cvw9/PAgXdbkTdrYZQjNlZrACM66A7gECRr9P1HHXIWwp5gox87Fqh1haCxPeAciqJRzqg5qzu+W3B6EoHKRRWiPlAL1JVzl7+GdYmIrTVScaEcscY6mtQ5CZm+XtdF2sN87s64xZTGfvDhDVphhH/3usZTwoF9PRnKuDTxQzH4Q62E0eshW44JXes9s6MFL0jgUZLnD62hgcbb1TylJSBE3hnZagzW4waakF/Pc1vuPsACVLYGKYPHI3N67DrMiCNwqsH/Wv+Ym/kdYtAgp1qYTZTYmhRMc2FxRIRO0eSl0SCebacrxB4BOOFqB5dfi1+/lgeUByaW6uKuBAzc8O2gDRDpa379Z5f+7kHDpQZ4M83RpUP5EeXNNVdYdTEj/w=
